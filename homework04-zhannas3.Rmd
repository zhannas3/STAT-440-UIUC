---
title: "STAT 440 Statistical Data Management - Spring 2022"
output: html_document
---

## Homework04
### Due: Monday April 04, 2022 11:59 pm US Central Time
#### Created by Christopher Kinson

Grading Rubric (per question):  
2 points if complete and correct  
1 point if incomplete or incorrect  
0 points if no attempt made  


**Retrieving your work**

This and all future homework .Rmd files are written in Markdown. The .Rmd file can be rendered as an .html file for easier viewing. This and all future homework assignments are located in the **homework** directory within the **stat440-sp22-course-content** repo, i.e. **stat440-sp22-course-content/homework** in GitHub. It is always recommended that you **pull** (or refresh) the **stat440-sp22-course-content** repo to ensure that you have the most updated version of all course content including the homework assignments. After pulling (or refreshing) the **stat440-sp22-course-content** repo, the homework file will be in the homework directory. Once you have opened the .Rmd file, you may begin writing your answers beneath each problem. Do not remove any of the original problems from the file, because that makes it more difficult for the course staff to grade your assignment. 

**Submitting your work**

In your individual student repo (named as your netID), you are to submit ***two*** files:

a. Your reproducible document file (.Rmd) which should be saved as homework#-netID.Rmd. For example, my homework 01 file would be saved as homework01-kinson2.Rmd.

b. Your rendered reproducible document file (.html) which should be saved as homework#-netID.html. For example, my homework 01 file would be saved as homework01-kinson2.html.

**Do not place your files in a sub-directory (or folder).** You have an unlimited number of submissions, but only the latest proper submission (commit and push) will be viewed and graded. **Remember the .Rmd file needs to render properly to .html before submitting.** 


***

Undergraduates are expected to complete the problems **#1-#8**. Graduate students are expected to complete all problems.

**The following problems should be completed by you as an individual. If any problem asks you a particular question, be sure to answer it completely (with code, written sentences, or both). Written sentences should not appear in code chunks or code cells. Written sentences should appear in Markdown syntax unless specifically stated otherwise.**

***Do not change anything in this file above the double line. Doing so will prevent your homework from being graded.***

***
***

### Use the URLs to access the data. No local files allowed.


**#1** This problem includes concepts from the following notes/videos: Markdown.

**Problem:** Using Markdown syntax, make a numbered list with your netID in normal text as the first item and full name in normal text as the second item.

**Answer:** 

1. zhannas3
2. Zhanna Sakayeva

**#2** This problem includes concepts from the following notes/videos: Markdown.

**Problem:** Think about the previous two weeks (your experiences, assignments, and life). Using Markdown, describe in paragraph form (with at least 3 complete sentences): what was the most challenging part(s) about those weeks, and the thing(s) that made your weeks successful or unsuccessful.

**Answer:** 

The good thing about the last two weeks was a Spring break, when we had a chance to relax a bit. Also I had two important deadlines last week which was a little bit stressful. Overall I am doing good. 

**#3** This problem includes concepts from the following notes/videos: Tool-making and programming Part01, Markdown.

**Problem:** If the statement below is TRUE, then write TRUE in the **Answer** section and provide evidence (code and results) that it is TRUE. If the statement below is FALSE, then write FALSE in the **Answer** section and provide evidence (code and results) that it is FALSE.

- Statement: R's `return()` function is always required for a user-defined function to operate.

**Answer:**  

FALSE

```{r prob3}
twosam <- function(y1, y2) {
  n1 <- length(y1); n2 <- length(y2)
  yb1 <- mean(y1); yb2 <- mean(y2)
  s1 <- var(y1); s2 <- var(y2)
  s <- ((n1-1)*s1 + (n2-1)*s2)/(n1+n2-2)
  tst <- (yb1 - yb2)/sqrt(s*(1/n1 + 1/n2))
  tst
}
twosam(rnorm(20),rnorm(20))
```

**#4** This problem includes concepts from the following notes/videos: Tool-making and programming Part01, Markdown.

**Problem:** If the statement below is TRUE, then write TRUE in the **Answer** section and provide evidence (code and results) that it is TRUE. If the statement below is FALSE, then write FALSE in the **Answer** section and provide evidence (code and results) that it is FALSE.

- Statement: Arguments in a user-defined function in R are not required to be named.

**Answer:**   

TRUE

```{r prob4}
exc <- function(n,rho){
  mat <- array(rho,dim=c(n,n))
  mat2 <- array(c(1:n,1:n),dim=c(n,2))
  mat[mat2] <- 1 
  mat
}
exc(5,0.5)
```

**#5** This problem includes concepts from the following notes/videos: Accessing and importing data, SQL for weeks 03-07 content, SQL sub-queries.

**Problem:** After importing the Champaign County Sheriff Office & Jail Data using its data URL https://uofi.box.com/shared/static/b6kuknulot4bqyo7elc8gmm6qzhnk766.dat, use any SQL-specific cleaning data approaches to correct the misspelled cities: Champaign and Urbana. Your resulting evidence should be written in the **Answer** section below and appear as a table or tibble containing the counts of these two cities (corrected spellings).

- Data description for Champaign County Sheriff Office & Jail Data: The dataset contains 11082 observations and 40 columns for individuals who were booked into jail in Champaign County Jail in the year 2019. The individuals are identifiable based on personal identity, and they are given unique jacket numbers. Some rows in the data appear more than once because of multiple crimes being assigned to one person. But there is also the possibility of there being recidivists. A recidivist is a person who goes to jail repeatedly (more than one datetime). The demographics of the people, reasons for being booked, and crime code are also given in the data. The original source is the Champaign County Sheriff Office & Jail (CCSO).

**Answer:** CHAMPAIGN 4668, URBANA 2564	 

```{r prob5}
library(tidyverse)
library(sqldf)
jail <- read_csv("https://uofi.box.com/shared/static/b6kuknulot4bqyo7elc8gmm6qzhnk766.dat", 
    col_types = cols(booking_number = col_character(), 
        booking_date = col_character(), booking_time = col_character(), 
        released_date = col_character(), 
        released_time = col_character()))
#colnames(jail)
jail1 <- sqldf("SELECT city,
      CASE 
          WHEN city='CHAAMPAIGN' THEN 'CHAMPAIGN'
          WHEN city='CHAMAIGN' THEN 'CHAMPAIGN'
          WHEN city='CHAMAPAIGN' THEN 'CHAMPAIGN'
          WHEN city='CHAMAPIAGN' THEN 'CHAMPAIGN'
          WHEN city='CHAMAPIGN' THEN 'CHAMPAIGN'
          WHEN city='CHAMPAGIN' THEN 'CHAMPAIGN'
          WHEN city='CHAMPAIGN' THEN 'CHAMPAIGN'
          WHEN city='CHAMPAIGN,' THEN 'CHAMPAIGN'
          WHEN city='CHAMPAING' THEN 'CHAMPAIGN'
          WHEN city='CHAMPIAGN' THEN 'CHAMPAIGN'
          WHEN city='URBANA' THEN 'URBANA'
          WHEN city='URANA' THEN 'URBANA'
          WHEN city='URBNANA' THEN 'URBANA'
          ELSE 'NA'
          END AS city1
       FROM jail
      ")
#jail1
sqldf("SELECT city1, COUNT(city1) AS counts
       FROM jail1
       WHERE city1 ='CHAMPAIGN' OR city1 = 'URBANA'
       GROUP BY city1
      ")
```

**#6** This problem includes concepts from the following notes: SQL for weeks 03-07 content, SQL sub-queries, Markdown.

**Problem:** Beginning with the data imported in **Problem 5**, answer the following question in complete sentence(s) using Markdown syntax and showing SQL code and results as evidence of your answer.

- **How many recidivists had a change in employment status?** Write your answer in the **Answer** section below in Markdown syntax with complete sentence(s) and show SQL code and result as evidence. Hint: There are 915 recidivists in the data.

**Answer:** 441 recidivists had a change in employment status.

```{r prob6}
jail2 <- sqldf("SELECT jacket_number, COUNT(jacket_number) AS num, employment_status
      FROM (SELECT DISTINCT newid, *
      FROM (SELECT *, booking_number + jacket_number AS newid
      FROM jail))
      GROUP BY jacket_number
      HAVING num>1")
#jail2
jail21 <- sqldf("SELECT *, COUNT(employment_status) AS num1
      FROM jail
      WHERE jacket_number IN (SELECT jacket_number FROM jail2)
      GROUP BY jacket_number, employment_status")

#jail21
jail213 <- sqldf("SELECT *, COUNT(jacket_number) AS num2
                 FROM jail21
                 GROUP BY jacket_number
                 HAVING num2>1")
#jail213
nrow(jail213)
```

**#7** This problem includes concepts from the following notes/videos: Arranging data, Data reduction, Data expansion, Vectorization, Regular expressions and string manipulation, Summarizing data, Combining data, SQL for weeks 03-07 content, SQL sub-queries, Tool-making and programming Part01, Data visualization using base R, Markdown.

**Problem:** Use any data management concepts in order to recreate the data visualization below in the **Answer** section using base R visualization methods. Your recreated data visualization should appear almost identical to the one shown below. Screenshots will not be accepted. Your image must be rendered based on your code. SQL is not required.

![Image07](https://uofi.box.com/shared/static/ueyq26ml814rejclxca1a9kmc6h8ijwr.png)

**Answer:**

```{r prob7}
library(tidyverse)

df <- sqldf("SELECT COUNT(booking_number) AS numm, race from jail where race is not null
      group by race 
      ORDER BY numm ASC")
#df
gh <- df%>%
  select(numm, race)
#gh
par(mar=c(6,5,4,4),mgp=c(3,1,0)) 
bp <- barplot(sort(gh$numm, decreasing=FALSE), main="Champaign County Jail Bookings in 2019", horiz = TRUE, beside=TRUE, names.arg=c("NAmerican", "Unknown","APIslander", "Hispanic","White","Black"), xlab="",cex.names=0.8, axes=FALSE, cex.lab=1.2, las=2, col = c("#92cce4", "#52b0da", "#0794cb",  "#0073bb", "#0053a1","#00316f"), border = NA, mgp=c(1, 0, 1))

#axis(side = 2, bp, tick=FALSE, labels = FALSE, , las = 1)
text(x=5956, y=6.7, "6252", col = "white")
text(x=3720, y=5.5, "3979", col = "white")
text(x=780, y=4.3, "576", col = "black")
text(x=320, y=3.1, "119", col = "black")
text(x=190, y=1.9, "44", col = "black")
text(x=150, y=0.7, "13", col = "black")

```

**#8** This problem includes concepts from the following notes/videos: SQL for weeks 03-07 content, SQL sub-queries.

**Problem:** Import the 2020 NBA Season Data (four datasets total) using these four URLs https://uofi.box.com/shared/static/grgt4wkiumfjgpug3fsx2vfkipv5rxz1.json, https://uofi.box.com/shared/static/af959qr9ewjgain1obkzmagapkmw8wbj.json, https://uofi.box.com/shared/static/raqot999l9yo6qz26k13epitft9j2ay4.json, https://uofi.box.com/shared/static/gcyl1gya0qkoceg0vpydd26mpwczrs56.json, and address the following (in this order) using at least two SQL subqueries and SQL-specific data management concepts:

  - combine the four data sets into a new object called "nba2020"

  - summarize the data such that all basketball statistics are totaled across all stints per player; there should only be 540 players after summarizing; use the final stint's Position, Age, and Team for each player

  - mutate a new column called "REBOUNDS" that represents a combination of offensive rebounds and defensive rebounds

  - mutate a new column called "ATO" that represents the assists to turnovers ratio (assists divided by turnovers)

  - mutate a new column called "PTM" that represents the points to minutes played ratio (points divided by minutes played)

  - mutate a new column called "3PP" that represents three-point shots made out of three-point attempts multiplied by 100

  - de-select the stint column

- Now, print the first 15 observations of the resulting "nba2020" data object such that the data is sorted by PTM in descending order and only the following columns are selected: PlayerName, PlayerID, Pos, Tm, Age, PTM.

- Data description for the 4 NBA 2020 Season datasets: The dataset (four .json files) contains a total of 540 unique observations and 26 columns. The observations are professional basketball players in the National Basketball Association (NBA) and their season statistics for the 2020-2021 season. A stint is the duration of time someone worked for a particular employer. In this basketball data, a stint is a number representing the time a player was with a particular team. Some players are traded during the season, which means they would have more than 1 stint. A player's basketball statistics start over for each stint they have in a season. There are 540 unique player IDs across all stints. The original source is the NBA and Sports Reference. Also see the [2020 NBA Data Key](https://uofi.box.com/shared/static/oe2bbjn0xyhs9azbxaz00ab5ua6nbr9r.pdf).

**You may use tidyverse functionality to clean the fourth NBA dataset, but all other parts should be done in SQL.**

**Answer:** 

```{r prob8} 
library(tidyverse)
library(jsonlite)

nba1 <- fromJSON("https://uofi.box.com/shared/static/grgt4wkiumfjgpug3fsx2vfkipv5rxz1.json")
nba2 <- fromJSON("https://uofi.box.com/shared/static/af959qr9ewjgain1obkzmagapkmw8wbj.json")
nba3 <- fromJSON("https://uofi.box.com/shared/static/raqot999l9yo6qz26k13epitft9j2ay4.json")
nba4 <- fromJSON("https://uofi.box.com/shared/static/gcyl1gya0qkoceg0vpydd26mpwczrs56.json")
#nba1
#nba2
#nba3
nba42 <- nba4 %>%
  mutate(PlayerName = str_split(str_replace_all(Player,"\\\\","&"), "\\&", simplify=TRUE)[,1], 
         PlayerID = str_split(str_replace_all(Player,"\\\\","&"), "\\&", simplify=TRUE)[,2]) %>%
  select(PlayerID, PlayerName, everything(), -Player)
#nba42
nba2020 <- sqldf("SELECT *
      FROM (SELECT *
      FROM (SELECT *
      FROM nba42
      UNION
      SELECT *
      FROM nba3
      UNION
      SELECT *
      FROM nba2
      UNION
      SELECT *
      FROM nba1))
      GROUP BY PlayerID")
#nba2020

nbac2 <- sqldf("SELECT PlayerName, PlayerID, Pos,Age, Tm, sum(G) AS G, sum(GS) AS GS, sum(MP) AS MP, sum(FG) AS FG, sum(FGA) AS FGA, sum(`3P`) AS `3P`, sum(`3PA`) AS `3PA`, sum(`2P`) AS `2P`, sum(`2PA`) AS `2PA`, sum(FT) AS FT, sum(FTA) AS FTA, sum(ORB) AS ORB, sum(DRB) AS DRB, sum(AST) AS AST, sum(STL) AS STL, sum(BLK) BLK, sum(TOV) AS TOV, sum(PF) AS PF, sum(PTS) AS PTS
      FROM nba2020
      GROUP BY PlayerID")
#nbac2
nba20201 <- sqldf("SELECT *, 1.00*AST/TOV AS ATO, 1.00*PTS/MP AS PTM, 100.00*`3P`/`3PA` AS `3PP`, ORB+DRB AS                                 REBOUNDS
                  FROM nbac2")

sqldf("SELECT PlayerName, PlayerID, Pos, Tm, Age, PTM
      FROM nba20201
      ORDER BY PTM DESC
      LIMIT 15")
```

**#9**  This problem includes concepts from the following notes/videos: SQL for weeks 03-07 content, SQL sub-queries.

**Problem:** Using the 2020 Season NBA Data (**imported in Problem 8**), apply SQL-specific data management concepts to answer the following question:

- **Which (if any) of the 15 most efficient players made the 2020 US Olympic Basketball Team?** Write your answer in the **Answer** section below in Markdown syntax with complete sentence(s) and show SQL code and result as evidence. The formula for efficiency is: $$\frac{PTS + TRB + AST + STL + BLK - \big((FGA - FG) + (FTA - FT) + TOV)\big)}{G}$$ This link https://www.usab.com/mens/national-team/roster.aspx may be of assistance in identifying 2020 US Olympic Men's Basketball Team.

**Answer:** Among 15 most efficent players, only Kevin Durant made the 2020 US Olympic Basketball Team.

```{r prob9}
nba2020new <- sqldf("SELECT *, 1.00*(PTS+REBOUNDS+AST+STL+BLK-((FGA-FG)+(FTA-FT)+TOV))/G AS Efficiency
      FROM nba20201
      ")

sqldf("SELECT PlayerID, PlayerName, Efficiency
      FROM nba2020new
      ORDER BY Efficiency DESC
      LIMIT 15")
```

**#10** This problem includes concepts from the following notes/videos: Arranging data, Data reduction, Data expansion, Vectorization, Regular expressions and string manipulation, Summarizing data, Combining data, SQL for weeks 03-07 content, SQL sub-queries, Tool-making and programming Part01, Data visualization using base R, Markdown.

**Problem:** Use any data management concepts in order to recreate the data visualization below in the **Answer** section using base R visualization methods. Your recreated data visualization should appear almost identical to the one shown below. Screenshots will not be accepted. Your image must be rendered based on your code. SQL is not required.

![Image10](https://uofi.box.com/shared/static/jop3mha6u84zei5lcpj24mxd9l2nx5ga.png)

**Answer:** 

```{r prob10}

par(mgp=c(2,1,0), mar=c(4,4,4,1))
nba2020k <- sqldf("SELECT *, STL+BLK+DRB AS Defensive, FT+FG+ORB+AST AS Offensive 
                  FROM nba2020")

pp <- plot(nba2020k$Offensive, nba2020k$Defensive, main = "2020 NBA Season Offensive vs Defensive Play", pch=19, xlab = "Offensive = FT+FG+ORB+AST", ylab = "Defensive = STL+BLK+DRB", col="#d2d3d3",frame.plot=FALSE, axes=FALSE, mgp=c(3, 1, 1))

nba2020k%>%
  filter(PlayerName == "Rudy Gobert")%>%
  select(Offensive, Defensive)

abline(0, 950/953, col='black')

axis(side=2, 
     at=seq(0,750,250), 
     labels=TRUE, 
     tick=FALSE,
     las=3
     )
axis(side=1, 
     at=seq(0,1750,250), 
     labels=TRUE, 
     tick=FALSE,
     las=1
     )

points(950, 953, col='#2297e7',  pch=19)
text(x = 750, y = 953, "Rudy Gobert", col = '#2297e7')
grid()
```
